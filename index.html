<!doctype html>
<html lang="es" data-mode="dark">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <meta name="theme-color" content="#0D0D0F" />
  <title>Squash Solo Pro ‚Äî v1.5</title>
  <style>
    /* =========================================
       THEME TOKENS ‚Äî Squash Pro Premium
       ========================================= */
    :root {
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 40px;
      --space-10: 64px;
      --radius-2: 12px;
      --radius-4: 24px;
      --radius-round: 999px;
      --font-display: "Outfit", "Segoe UI", system-ui, sans-serif;
      --font-body: "Inter", system-ui, sans-serif;
      --font-mono: "JetBrains Mono", "SF Mono", monospace;
      --dur-1: 200ms;
      --dur-2: 400ms;
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out: cubic-bezier(0.65, 0, 0.35, 1);
    }

    /* Helper for HSL colors */
    @function h_s_l($h, $s, $l, $a: 1) {
      @return hsla($h, $s, $l, $a);
    }

    :root[data-mode="light"] {
      --bg: hsl(210, 20%, 98%);
      --surface: hsl(0, 0%, 100%);
      --surface-2: hsl(210, 25%, 94%);
      --ink: hsl(210, 40%, 10%);
      --ink-2: hsl(210, 20%, 30%);
      --muted: hsl(210, 15%, 50%);
      --line: hsla(210, 20%, 0%, 0.1);
      --line-strong: hsl(210, 40%, 10%);
      --accent: hsl(210, 100%, 50%);
      --accent-glow: hsla(210, 100%, 50%, 0.15);
      --accent-2: hsl(350, 90%, 55%);
      --accent-3: hsl(145, 60%, 45%);
      --shadow: 0 8px 32px hsla(210, 30%, 10%, 0.08);
      --glass: rgba(255, 255, 255, 0.7);
      --glass-blur: blur(12px);
    }

    :root[data-mode="dark"] {
      --bg: hsl(210, 30%, 4%);
      --surface: hsla(210, 25%, 8%, 0.8);
      --surface-2: hsla(210, 20%, 12%, 0.5);
      --ink: hsl(210, 20%, 98%);
      --ink-2: hsl(210, 15%, 85%);
      --muted: hsl(210, 10%, 60%);
      --line: hsla(210, 20%, 100%, 0.1);
      --line-strong: hsl(210, 10%, 90%);
      --accent: hsl(200, 100%, 60%);
      --accent-glow: hsla(200, 100%, 60%, 0.2);
      --accent-2: hsl(350, 100%, 65%);
      --accent-2-glow: hsla(350, 100%, 65%, 0.2);
      --accent-3: hsl(145, 70%, 60%);
      --accent-3-glow: hsla(145, 70%, 60%, 0.2);
      --shadow: 0 12px 48px hsla(0, 0%, 0%, 0.5);
      --glass: rgba(20, 22, 28, 0.7);
      --glass-blur: blur(24px);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at var(--glow-x, 50%) var(--glow-y, 50%), var(--glow-color, transparent) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
      opacity: 0.4;
      transition: background var(--dur-2) var(--ease-out);
    }

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@700;900&display=swap');

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--font-body);
      line-height: 1.6;
      transition: background var(--dur-2) var(--ease-out), color var(--dur-2);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--glass);
      backdrop-filter: var(--glass-blur);
      border-bottom: 1px solid var(--line);
      padding: var(--space-4) var(--space-6);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .wrap {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-6) var(--space-4);
      display: grid;
      gap: var(--space-6);
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-2);
      box-shadow: var(--shadow);
      padding: var(--space-6);
      overflow: hidden;
      backdrop-filter: var(--glass-blur);
    }

    .row {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .btn {
      min-height: 44px;
      border-radius: var(--radius-2);
      border: 1px solid var(--line-strong);
      padding: 10px 20px;
      background: var(--ink);
      color: var(--bg);
      font-family: var(--font-display);
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all var(--dur-1) var(--ease-out);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    .btn.ghost {
      background: transparent;
      color: var(--ink);
      border-color: var(--line-strong);
    }

    .btn.accent {
      background: var(--accent);
      border-color: transparent;
      color: #fff;
    }

    .kpi {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
    }

    .kpi b {
      color: var(--ink);
      font-size: 14px;
      font-family: var(--font-display);
    }

    .h-title {
      font-family: var(--font-display);
      font-weight: 900;
      color: var(--ink);
      text-transform: uppercase;
      font-size: 18px;
      margin: 0 0 var(--space-4) 0;
    }

    .block {
      background: var(--surface-2);
      border: 1px solid var(--line);
      border-radius: var(--radius-2);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
    }

    .block.active {
      border-color: var(--accent);
      border-width: 2px;
    }

    .timer-display {
      font-family: var(--font-mono);
      font-size: 40px;
      font-weight: 700;
      color: var(--ink);
      line-height: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 120px;
      height: 120px;
    }

    .timer-svg {
      position: absolute;
      inset: 0;
      transform: rotate(-90deg);
    }

    .timer-circle-bg {
      fill: none;
      stroke: var(--line);
      stroke-width: 8;
    }

    .timer-circle-prog {
      fill: none;
      stroke: var(--accent);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s linear, stroke var(--dur-1);
    }

    .timer-active {
      color: var(--accent);
      text-shadow: 0 0 12px var(--accent-glow);
    }

    .timer-ended {
      color: var(--accent-2);
      animation: pulse 1s infinite alternate;
    }

    .timer-ended .timer-circle-prog {
      stroke: var(--accent-2);
    }

    @keyframes pulse {
      from {
        opacity: 1;
      }

      to {
        opacity: 0.5;
      }
    }

    .pill {
      display: inline-block;
      background: var(--surface);
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--muted);
      margin-right: 8px;
    }

    .manual-box {
      background: var(--surface);
      padding: var(--space-4);
      border-radius: 8px;
      margin-top: var(--space-4);
      font-size: 13px;
    }

    .manual-label {
      font-size: 10px;
      font-weight: 900;
      color: var(--accent-2);
      text-transform: uppercase;
      display: block;
      margin-bottom: 8px;
    }

    .chart-container {
      margin-top: 24px;
    }

    .bar {
      fill: var(--accent);
      rx: 4;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: var(--surface);
      border: 2px solid var(--line-strong);
      padding: 10px 24px;
      border-radius: 999px;
      font-family: var(--font-display);
      font-weight: 900;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--dur-1);
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
    }

    select.btn {
      text-transform: none;
      font-family: var(--font-mono);
      font-size: 11px;
    }

    /* Focus Mode Overlay */
    .focus-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 2000;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--space-8);
      text-align: center;
      animation: fadeIn var(--dur-2) var(--ease-out);
    }

    .focus-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .focus-timer {
      font-size: 120px;
      font-family: var(--font-mono);
      margin: var(--space-6) 0;
      font-weight: 900;
    }

    .focus-drill-title {
      font-size: 32px;
      font-family: var(--font-display);
      text-transform: uppercase;
      margin-bottom: var(--space-4);
    }

    .focus-pill {
      background: var(--surface-2);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-round);
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div style="display:flex; align-items:center; gap:var(--space-3);">
      <h1 style="font-family:var(--font-display); font-weight:900; font-size:20px; margin:0; text-transform:uppercase;">
        Squash <span style="color:var(--accent)">Solo</span>
      </h1>
      <span id="wakeLockIndicator"
        style="display:none; font-size:10px; background:var(--accent-3); color:#fff; padding:2px 8px; border-radius:10px;">LIVE</span>
      <span id="safetyReminder"
        style="font-size:10px; border:1px solid var(--accent-2); color:var(--accent-2); padding:2px 8px; border-radius:10px; cursor:pointer;"
        onclick="toggleSafety()">
        ‚ö†Ô∏è GAFAS: <span id="safetyText">REQUERIDAS</span>
      </span>
    </div>
    <button class="btn ghost" id="themeToggle" style="padding:6px 12px; font-size:10px;">MODO</button>
  </header>

  <main class="wrap">
    <!-- CONFIGURACI√ìN -->
    <section class="card">
      <div
        style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:var(--space-4); margin-bottom:var(--space-5);">
        <div>
          <h2 class="h-title" style="margin:0; font-size:16px;">Sesi√≥n Actual</h2>
          <div class="row" style="margin-top:8px;">
            <div class="kpi"><b id="kpiTotal">15</b> min</div>
            <div class="kpi"><b id="kpiDone">0</b> bloques</div>
          </div>
        </div>
        <div style="display:flex; gap:var(--space-3);">
          <div>
            <label
              style="font-size:9px; font-weight:900; color:var(--muted); text-transform:uppercase; display:block; margin-bottom:4px;">Duraci√≥n</label>
            <select id="durationSelect" class="btn ghost">
              <option value="15">15 min</option>
              <option value="30">30 min</option>
              <option value="45">45 min</option>
              <option value="60">60 min</option>
            </select>
          </div>
          <div>
            <label
              style="font-size:9px; font-weight:900; color:var(--muted); text-transform:uppercase; display:block; margin-bottom:4px;">Enfoque</label>
            <select id="planSelect" class="btn ghost"></select>
          </div>
        </div>
      </div>

      <div class="row" style="margin-bottom:var(--space-5);">
        <button class="btn ghost" id="btnNotif" style="font-size:10px; padding:6px 12px;">AVISOS: OFF</button>
        <button class="btn ghost" id="btnAuto" style="font-size:10px; padding:6px 12px;">AUTO: OFF</button>
        <div id="sessionCounter"
          style="margin-left:auto; font-family:var(--font-mono); font-weight:900; font-size:18px; color:var(--accent);">
          #01</div>
      </div>

      <div class="manual-box"
        style="margin-top:0; margin-bottom:var(--space-5); border-left:4px solid var(--accent-3);">
        <span class="manual-label" style="color:var(--accent-3);">Sugerencia de Equipo</span>
        <div id="ballAdvice" style="font-size:13px; font-weight:600;">--</div>
      </div>

      <div class="block" style="margin-bottom:var(--space-5);">
        <details>
          <summary class="h-title" style="font-size:12px; cursor:pointer; color:var(--accent-3); display:list-item;">
            Gestionar Ejercicios (Editor)
          </summary>
          <div style="margin-top:var(--space-4);">
            <div id="exForm"
              style="display:grid; gap:var(--space-3); padding:var(--space-4); background:var(--surface-2); border-radius:8px;">
              <input type="text" id="exTitle" placeholder="T√≠tulo del ejercicio (ej: Drive Recto)" class="btn ghost"
                style="text-align:left; font-size:13px;">
              <input type="text" id="exSetup" placeholder="Setup (ej: En la caja de saque)" class="btn ghost"
                style="text-align:left; font-size:13px;">
              <textarea id="exExplain" placeholder="Explicaci√≥n del ejercicio..." class="btn ghost"
                style="text-align:left; font-size:13px; min-height:60px;"></textarea>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:var(--space-3);">
                <input type="text" id="exGood" placeholder="Bien: (punto clave)" class="btn ghost"
                  style="text-align:left; font-size:13px;">
                <input type="text" id="exBad" placeholder="Mal: (error com√∫n)" class="btn ghost"
                  style="text-align:left; font-size:13px;">
              </div>
              <div style="display:flex; gap:var(--space-3); align-items:center;">
                <select id="exBlock" class="btn ghost" style="flex:1;">
                  <option value="wu">Calentamiento</option>
                  <option value="ae">Paralelas</option>
                  <option value="th">Figura 8</option>
                  <option value="pw">Movimiento</option>
                  <option value="gm">Presi√≥n</option>
                </select>
                <button class="btn accent" id="btnAddEx" style="flex:1;">A√±adir Ejercicio</button>
              </div>
            </div>

            <div id="customList" style="margin-top:var(--space-5); display:grid; gap:var(--space-3);">
              <!-- Custom exercises appear here -->
            </div>

            <div style="border-top:1px solid var(--line); margin-top:var(--space-5); padding-top:var(--space-4);">
              <h4 class="h-title" style="font-size:10px; margin-bottom:10px;">Importar via TXT (Avanzado)</h4>
              <input type="file" id="txtImport" accept=".txt,text/plain" class="btn ghost"
                style="width:100%; padding:8px;">
              <p style="font-size:10px; color:var(--muted); margin-top:8px;">
                Carga un archivo <b>.txt</b> con ejercicios. Formato: t√≠tulo en 1ra l√≠nea, luego <code>Setup:</code>,
                <code>Explica:</code>, <code>Bien:</code>, <code>Mal:</code>, <code>Bloque:</code> (wu/ae/th/pw/gm).
              </p>
            </div>
          </div>
        </details>
      </div>

      <div id="sessionBlocks"></div>

      <div id="completionZone" style="display:none; margin-top:30px;">
        <h3 class="h-title" style="font-size:12px; color:var(--accent-3);">Resumen de Esfuerzo</h3>
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:15px;">
          <input type="number" id="rpeInput" min="1" max="10" placeholder="RPE 1-10"
            style="padding:12px; border-radius:10px; background:var(--surface-2); border:1px solid var(--line); color:var(--ink);">
          <textarea id="notesInput" rows="2" placeholder="Notas t√©cnicas..."
            style="padding:12px; border-radius:10px; background:var(--surface-2); border:1px solid var(--line); color:var(--ink);"></textarea>
        </div>
        <div class="row" style="margin-top:20px;">
          <button class="btn accent" id="btnComplete" style="flex:2;">Guardar Sesi√≥n</button>
          <button class="btn ghost" id="btnReset" style="flex:1;">Descartar</button>
        </div>
      </div>
    </section>

    <!-- PRO TIPS -->
    <section class="card">
      <h2 class="h-title" style="font-size:14px; color:var(--accent-2);">Gu√≠a T√©cnica R√°pida</h2>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-4);">
        <div
          style="padding:12px; border-left: 3px solid var(--accent); background:var(--surface-2); border-radius:8px; font-size:12px;">
          <b>Control de Pared:</b> Mant√©n los hombros paralelos a la pared lateral para drives rectos.
        </div>
        <div
          style="padding:12px; border-left: 3px solid var(--accent-3); background:var(--surface-2); border-radius:8px; font-size:12px;">
          <b>Paso de T:</b> Vuelve siempre al centro tras golpear. No te quedes mirando la bola.
        </div>
        <div
          style="padding:12px; border-left: 3px solid var(--accent-2); background:var(--surface-2); border-radius:8px; font-size:12px;">
          <b>Stop Rule:</b> Si la t√©cnica colapsa o hay fatiga extrema, det√©n el bloque. Calidad > Volumen.
        </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section class="card">
      <h2 class="h-title" style="font-size:14px;">Evoluci√≥n (RPE)</h2>
      <div class="chart-container">
        <svg id="rpeChart" viewBox="0 0 300 100" preserveAspectRatio="none" style="height:100px; width:100%;">
          <line x1="0" y1="100" x2="300" y2="100" stroke="var(--line)" stroke-width="1"></line>
        </svg>
      </div>
      <div class="row" style="margin-top:24px;">
        <button class="btn ghost" id="btnExportCSV" style="flex:1; font-size:10px;">Exportar CSV</button>
        <button class="btn ghost" id="btnWipe" style="flex:1; font-size:10px; color:var(--accent-2);">Borrar
          Todo</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- FOCUS MODE OVERLAY ‚Äî eyes-free design -->
  <div id="focusOverlay" class="focus-overlay">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%; max-width:500px;">
      <div id="focusPill" class="focus-pill">CALENTAMIENTO</div>
      <button onclick="toggleFocus(null,true)" class="btn ghost" style="font-size:11px; padding:6px 14px;">‚úï Salir</button>
    </div>

    <div id="focusTitle" class="focus-drill-title">---</div>

    <div class="timer-display" style="width:240px; height:240px; font-size:80px;">
      <svg class="timer-svg" viewBox="0 0 100 100">
        <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
        <circle id="focusCircle" class="timer-circle-prog" cx="50" cy="50" r="45" stroke-dasharray="283"
          stroke-dashoffset="0"></circle>
      </svg>
      <div id="focusTime">0:00</div>
    </div>

    <!-- Large tap targets for eyes-free metric tracking -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; width:100%; max-width:440px; margin-top:28px;">
      <button onclick="focusBump('racha')"
        style="min-height:120px; background:var(--surface-2); border:2px solid var(--line); border-radius:var(--radius-2); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:16px; cursor:pointer;">
        <span style="font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">Racha</span>
        <div id="focusRacha" style="font-size:44px; font-weight:900; line-height:1;">0</div>
        <span style="font-size:30px; color:var(--accent); font-weight:900; line-height:1;">+1</span>
      </button>
      <button onclick="focusBump('aciertos')"
        style="min-height:120px; background:var(--surface-2); border:2px solid var(--line); border-radius:var(--radius-2); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; padding:16px; cursor:pointer;">
        <span style="font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">Aciertos</span>
        <div id="focusAciertos" style="font-size:44px; font-weight:900; line-height:1;">0</div>
        <span style="font-size:30px; color:var(--accent); font-weight:900; line-height:1;">+1</span>
      </button>
    </div>

    <button onclick="announceBlock()" class="btn ghost" style="margin-top:20px; font-size:12px; padding:8px 20px;">
      üîä Leer Instrucciones
    </button>
  </div>

  <!-- AUDIO ASSETS (Generated via Web Audio API, but placeholders for logic) -->
  <audio id="audioBeep" src=""></audio>
  <audio id="audioWhistle" src=""></audio>

  <script>
    /* =========================================
       SQUASH SOLO PRO ‚Äî v1.5
       ========================================= */

    const STORE_KEY = "squash_pro_v1";
    const DEFAULT_STATE = {
      version: 7, count: 0, session: null, history: [],
      theme: "dark", plan_id: "foundation", total_min: 15,
      auto_advance: false, notif: false, custom_exercises: [],
      safety_accepted: false, ball_type: "double_yellow"
    };

    const catalog = {
      plans: [
        {
          id: "foundation", name: "Fundamentos: Control y Precisi√≥n",
          structure: [
            { id: "wu", weight: 0.15, label: "Calentamiento" },
            { id: "ae", weight: 0.35, label: "Paralelas" },
            { id: "th", weight: 0.20, label: "Figura 8" },
            { id: "pw", weight: 0.20, label: "Movimiento" },
            { id: "gm", weight: 0.10, label: "Presi√≥n" }
          ]
        },
        {
          id: "conditioning", name: "Condici√≥n: Resistencia (PSA Density)",
          structure: [
            { id: "wu", weight: 0.10, label: "Calentamiento" },
            { id: "pw", weight: 0.40, label: "Ghosting Intervalos", density: "15/45" },
            { id: "th", weight: 0.20, label: "Voleas Cruzadas" },
            { id: "ae", weight: 0.20, label: "Drives Fondo" },
            { id: "gm", weight: 0.10, label: "Finalizaci√≥n" }
          ]
        },
        {
          id: "attwell_volleys", name: "√âlite: Serie de Voleas Attwell",
          structure: [
            { id: "wu", weight: 0.10, label: "Calentamiento" },
            { id: "vl", weight: 0.80, label: "Especializaci√≥n Volea" },
            { id: "gm", weight: 0.10, label: "Toque" }
          ]
        },
        {
          id: "dead_ball", name: "Laboratorio: Bola Muerta (Precisi√≥n)",
          structure: [
            { id: "db", weight: 0.80, label: "Mec√°nica Est√°tica" },
            { id: "gm", weight: 0.20, label: "Objetivos Virtuales" }
          ]
        }
      ],
      blocks: {
        wu: [
          { id: "wu_1", stage: 1, title: "Calentamiento Pro", setup: "Frente a pared frontal.", manual: { explain: "2 toques suaves por lado + 1 bote. Prioriza ritmo.", good: "Impacto delante del cuerpo.", bad: "Golpear fuerte sin activar.", stop: "Fatiga prematura." } },
          { id: "wu_2", stage: 2, title: "Calentamiento Din√°mico", setup: "Frontal + desplazamiento lateral.", manual: { explain: "Alterna 3 voleas movi√©ndote medio paso.", good: "Split-step reactivo.", bad: "Pies est√°ticos.", stop: "Falta de coordinaci√≥n." } }
        ],
        ae: [
          { id: "ae_1", stage: 1, title: "Drives de Pasillo", setup: "Lateral a la caja de saque.", manual: { explain: "Golpe paralelo, 2¬∫ bote tras l√≠nea corta.", good: "Hombros paralelos a pared lateral.", bad: "Pegar de frente.", stop: "Si la bola se separa >30cm." } },
          { id: "ae_2", stage: 2, title: "Paralelas con Objetivos", setup: "Objetivo en el nick trasero.", manual: { explain: "10 bolas buscando el rail perfecto.", good: "Altura media, 'muere' atr√°s.", bad: "Buscar potencia, no longitud.", stop: "P√©rdida de control del rail." } }
        ],
        th: [
          { id: "th_1", stage: 1, title: "Figura de 8", setup: "En la T, bote permitido.", manual: { explain: "Cruza la bola de lado a lado.", good: "Raqueta lista antes del bote.", bad: "Cerrar swing muy tarde.", stop: "Golpeo descontrolado." } }
        ],
        pw: [
          { id: "pw_1", stage: 1, title: "Ghosting Estrella 6 Puntos", setup: "Sin bola, desde la T.", manual: { explain: "Patr√≥n 6 puntos: 4 esquinas + 2 laterales.", good: "Centro gravedad bajo y estable.", bad: "Pasos cruzados.", stop: "T√©cnica colapsada." } },
          { id: "pw_2", stage: 2, title: "Ghosting 15/45 (PSA)", setup: "15s trabajo / 45s pausa.", manual: { explain: "M√°xima explosividad en el intervalo.", good: "Primer paso explosivo.", bad: "Arrastrar los pies.", stop: "Incapacidad de recuperar aliento." } }
        ],
        gm: [
          { id: "gm_1", stage: 1, title: "Targets de Control", setup: "Botella en esquina trasera.", manual: { explain: "8 impactos cercanos al objetivo.", good: "Ritmo fluido.", bad: "Frustraci√≥n por fallos.", stop: "Si no logras 2/10." } },
          { id: "gm_2", stage: 2, title: "Finalizaci√≥n: 'Caja de Cereales'", setup: "Objetivo peque√±o en pared lateral.", manual: { explain: "Impacto seco en el objetivo t√°ctico.", good: "Concentraci√≥n externa total.", bad: "Swing excesivamente largo.", stop: "P√©rdida de punter√≠a." } }
        ],
        vl: [
          { id: "vl_1", stage: 1, title: "Voleas Ametralladora", setup: "2m de pared frontal.", manual: { explain: "Voleas muy r√°pidas para saturar antebrazo.", good: "Snap de mu√±eca seco.", bad: "Brazo r√≠gido.", stop: "Fallo muscular." } },
          { id: "vl_2", stage: 1, title: "Voleas Caminando", setup: "De pared frontal a trasera.", manual: { explain: "Retrocede voleando sin que caiga la bola.", good: "Ajuste de altura din√°mico.", bad: "P√©rdida de eje corporal.", stop: "P√©rdida de ritmo." } },
          { id: "vl_3", stage: 1, title: "Volea Chipped al Rail", setup: "Desde la T.", manual: { explain: "Volea flotada que busca profundidad.", good: "Cara raqueta abierta.", bad: "Golpear plano y fuerte.", stop: "Bolas muy cortas." } }
        ],
        db: [
          { id: "db_1", stage: 1, title: "Drive Est√°tico (Lanzado)", setup: "Lanza con la mano frente a ti.", manual: { explain: "Impacto seco antes del bote.", good: "Transferencia peso pie trasero a delantero.", bad: "Cucharear la bola.", stop: "Errores mec√°nicos repetitivos." } },
          { id: "db_2", stage: 1, title: "Drop de Toque Est√°tico", setup: "Cerca de frontal, bola alta.", manual: { explain: "Absorbe energ√≠a en las cuerdas.", good: "Codo relajado, mano suave.", bad: "Empujar en vez de guiar.", stop: "Bolas que rebotan mucho." } }
        ]
      }
    };

    const baseCatalogBlocks = structuredClone(catalog.blocks);

    // --- State Initialization ---
    function safeParse(json, fallback) { try { return JSON.parse(json) ?? fallback; } catch { return fallback; } }
    let state = safeParse(localStorage.getItem(STORE_KEY), null) || structuredClone(DEFAULT_STATE);
    if (!Array.isArray(state.custom_exercises)) state.custom_exercises = [];
    function save() { localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

    function normalizeBlockId(v) {
      const id = String(v || "").trim().toLowerCase();
      return ["wu", "ae", "th", "pw", "gm"].includes(id) ? id : "ae";
    }

    function parseExercisesTXT(content) {
      return content
        .split(/\n\s*\n/g)
        .map(chunk => chunk.trim())
        .filter(Boolean)
        .map((chunk, idx) => {
          const lines = chunk.split("\n").map(x => x.trim()).filter(Boolean);
          const title = lines[0] || `Ejercicio ${idx + 1}`;
          const setup = lines.find(x => /^setup\s*:/i.test(x))?.replace(/^setup\s*:/i, "").trim() || "Sin setup definido.";
          const explain = lines.find(x => /^(explica|explain)\s*:/i.test(x))?.replace(/^(explica|explain)\s*:/i, "").trim() || "Practica con control y ritmo progresivo.";
          const good = lines.find(x => /^bien\s*:/i.test(x))?.replace(/^bien\s*:/i, "").trim() || "Impacto limpio y balanceado.";
          const bad = lines.find(x => /^mal\s*:/i.test(x))?.replace(/^mal\s*:/i, "").trim() || "Forzar velocidad sin t√©cnica.";
          const blockIdRaw = lines.find(x => /^bloque\s*:/i.test(x))?.replace(/^bloque\s*:/i, "").trim();
          const blockId = normalizeBlockId(blockIdRaw);
          return {
            id: `custom_${Date.now()}_${idx}`,
            stage: 1, // Custom ones default to stage 1 to be always available
            title,
            setup,
            manual: { explain, good, bad },
            blockId
          };
        });
    }

    function mergeCustomExercises() {
      ["wu", "ae", "th", "pw", "gm"].forEach(id => {
        const custom = state.custom_exercises.filter(x => x.blockId === id);
        catalog.blocks[id] = [...baseCatalogBlocks[id], ...custom];
      });
    }

    // --- Helpers ---
    function nowISODate() { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`; }
    function escapeHTML(str) { return String(str).replace(/[&<>"'`]/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;", "`": "&#96;" }[c])); }
    function mmss(s) { const m = Math.floor(s / 60); const rs = Math.max(0, s % 60); return `${m}:${rs.toString().padStart(2, '0')}`; }
    function toast(msg) { const t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 2000); }

    const Alarm = {
      ctx: null,
      init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
      async play(type = "end") {
        try {
          this.init(); if (this.ctx.state === "suspended") await this.ctx.resume();
          const n = this.ctx.currentTime;
          // Distinct patterns per event type ‚Äî longer and louder than before
          const patterns = {
            start:   [{f:440,t:0,d:0.15},{f:660,t:0.18,d:0.15},{f:880,t:0.36,d:0.25}],
            end:     [{f:880,t:0,d:0.25},{f:660,t:0.3,d:0.25},{f:440,t:0.6,d:0.4}],
            warning: [{f:660,t:0,d:0.12},{f:660,t:0.16,d:0.12}],
            work:    [{f:880,t:0,d:0.2},{f:1100,t:0.25,d:0.2}],
            rest:    [{f:440,t:0,d:0.3},{f:330,t:0.35,d:0.3}],
            tick:    [{f:1000,t:0,d:0.05}]
          };
          const beeps = patterns[type] || patterns.end;
          beeps.forEach(({f,t,d}) => {
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.connect(g); g.connect(this.ctx.destination);
            o.type = "sine"; o.frequency.setValueAtTime(f, n + t);
            g.gain.setValueAtTime(0.35, n + t); g.gain.exponentialRampToValueAtTime(0.001, n + t + d);
            o.start(n + t); o.stop(n + t + d + 0.05);
          });
        } catch (e) { }
      }
    };

    // Speech synthesis ‚Äî announces drill names, transitions and countdowns
    const Speak = {
      synth: window.speechSynthesis,
      voice: null,
      init() {
        const pick = () => {
          const voices = this.synth.getVoices();
          this.voice = voices.find(v => v.lang.startsWith("es")) || voices[0] || null;
        };
        pick();
        if (this.synth.onvoiceschanged !== undefined) this.synth.onvoiceschanged = pick;
      },
      say(text, priority = false) {
        if (!this.synth) return;
        if (priority) this.synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        if (this.voice) u.voice = this.voice;
        u.lang = "es-ES"; u.rate = 0.95; u.pitch = 1.0; u.volume = 1.0;
        this.synth.speak(u);
      }
    };

    // Haptic vibration helper
    function vibe(pattern) { try { if (navigator.vibrate) navigator.vibrate(pattern); } catch(e){} }

    let wakeLock = null;
    async function toggleWake(on) {
      if (!("wakeLock" in navigator)) return;
      try {
        if (on && !wakeLock) { wakeLock = await navigator.wakeLock.request("screen"); document.getElementById("wakeLockIndicator").style.display = "inline"; }
        else if (!on && wakeLock) { await wakeLock.release(); wakeLock = null; document.getElementById("wakeLockIndicator").style.display = "none"; }
      } catch (e) { }
    }

    // --- Logic ---
    function ensureSessionIntegrity() {
      if (!state.session?.blocks) return;
      state.session.blocks.forEach(b => {
        if (b.timer.active && b.timer.endTime) {
          const rem = Math.ceil((b.timer.endTime - Date.now()) / 1000);
          b.timer.rem = Math.max(0, rem);
          if (b.timer.rem === 0) { b.timer.active = false; b.timer.finished = true; }
        }
      });
    }

    function getStageBySession(sessionNumber) {
      if (sessionNumber <= 4) return 1;
      if (sessionNumber <= 8) return 2;
      return 3;
    }

    function generate() {
      const n = (Number(state.count) || 0) + 1;
      const seed = n * 41;
      const pick = (arr, s) => arr[Math.abs(s) % arr.length];
      const plan = catalog.plans.find(p => p.id === state.plan_id) || catalog.plans[0];
      const totalSec = state.total_min * 60;
      const sessionStage = getStageBySession(n);

      const blocks = plan.structure.map((s, i) => {
        const pool = catalog.blocks[s.id].filter(b => b.stage <= sessionStage);
        const drill = pick(pool.length ? pool : catalog.blocks[s.id], seed + i);
        const blockSec = Math.round(totalSec * s.weight);
        return {
          ...drill,
          label: s.label,
          stage: drill.stage,
          seconds: blockSec,
          density: s.density || null,
          metrics: { racha: 0, aciertos: 0 },
          timer: { rem: blockSec, active: false, finished: false, endTime: null, isRest: false }
        };
      });
      state.session = { n, date: nowISODate(), plan_id: plan.id, plan_name: plan.name, blocks };
      save(); render(); toast("Plan generado");
      toggleWake(true);
      Speak.say(`Sesi√≥n ${n} lista. ${plan.name.split(":")[0]}. Toca el timer para comenzar.`);
    }

    function toggleSafety() {
      state.safety_accepted = !state.safety_accepted;
      save();
      const st = document.getElementById("safetyText");
      if (st) {
        st.textContent = state.safety_accepted ? "OK" : "REQUERIDAS";
        st.parentElement.style.borderColor = state.safety_accepted ? "var(--accent-3)" : "var(--accent-2)";
        st.parentElement.style.color = state.safety_accepted ? "var(--accent-3)" : "var(--accent-2)";
      }
    }

    function updateBallAdvice() {
      const el = document.getElementById("ballAdvice");
      if (!el) return;
      const plan = catalog.plans.find(p => p.id === state.plan_id);
      if (plan?.id === "dead_ball" || plan?.id === "attwell_volleys") {
        el.textContent = "Punto Rojo / Amarillo: Recomendado para precisi√≥n t√©cnica.";
        el.style.color = "var(--accent-2)";
      } else {
        el.textContent = "Doble Punto Amarillo: Recomendada para alta intensidad.";
        el.style.color = "var(--accent-3)";
      }
    }

    function renderChart() {
      const svg = document.getElementById("rpeChart"); if (!svg) return;
      svg.querySelectorAll(".bar").forEach(e => e.remove());
      const data = state.history.slice(-12);
      const spacing = 300 / 12;
      data.forEach((h, i) => {
        const v = Math.min(10, Math.max(1, Number(h.rpe) || 1));
        const r = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        r.setAttribute("x", i * spacing + 5); r.setAttribute("y", 100 - (v * 10));
        r.setAttribute("width", spacing - 10); r.setAttribute("height", v * 10);
        r.setAttribute("class", "bar"); svg.appendChild(r);
      });
    }

    function renderCustomList() {
      const list = document.getElementById("customList");
      if (!list) return;
      if (state.custom_exercises.length === 0) {
        list.innerHTML = `<div style="font-size:11px; color:var(--muted); text-align:center;">No hay ejercicios personalizados.</div>`;
        return;
      }
      list.innerHTML = state.custom_exercises.map((ex, idx) => `
        <div style="display:flex; justify-content:space-between; align-items:center; background:var(--surface); padding:8px 12px; border:1px solid var(--line); border-radius:6px; font-size:12px;">
          <div>
            <b style="color:var(--accent)">[${ex.blockId.toUpperCase()}]</b> ${escapeHTML(ex.title)}
          </div>
          <button class="btn ghost" onclick="deleteEx(${idx})" style="padding:4px 8px; font-size:10px; color:var(--accent-2);">Eliminar</button>
        </div>
      `).join("");
    }

    window.deleteEx = (idx) => {
      if (confirm("¬øEliminar este ejercicio?")) {
        state.custom_exercises.splice(idx, 1);
        save();
        mergeCustomExercises();
        render();
        renderCustomList();
        toast("Ejercicio eliminado");
      }
    };

    function render() {
      ensureSessionIntegrity();
      document.documentElement.setAttribute("data-mode", state.theme);
      const container = document.getElementById("sessionBlocks");
      const zone = document.getElementById("completionZone");
      const counter = document.getElementById("sessionCounter");

      document.getElementById("kpiTotal").textContent = state.total_min;

      if (!state.session) {
        counter.textContent = `#${(state.count + 1).toString().padStart(2, '0')}`;
        document.getElementById("kpiDone").textContent = "0";
        zone.style.display = "none";
        container.innerHTML = `<div style="text-align:center; padding:40px; border:2px dashed var(--line); border-radius:12px;"><button class="btn accent" id="btnGen">Comenzar Entrenamiento</button></div>`;
        document.getElementById("btnGen").onclick = generate;
      } else {
        counter.textContent = `#${state.session.n.toString().padStart(2, '0')}`;
        document.getElementById("kpiDone").textContent = state.session.blocks.filter(b => b.timer.finished).length;
        zone.style.display = "block";
        container.innerHTML = state.session.blocks.map((b, i) => `
          <div class="block ${b.timer.active ? 'active' : ''}">
             <div style="display:flex; justify-content:space-between; align-items:flex-start;">
               <div>
                 <span class="pill" style="color:var(--accent)">${escapeHTML(b.label)}</span>
                 <span class="pill">Nivel ${b.stage}/3</span>
                 <div style="font-family:var(--font-display); font-weight:900; font-size:18px;">${escapeHTML(b.title)}</div>
               </div>
               <div class="timer-display ${b.timer.active ? 'timer-active' : ''} ${b.timer.finished ? 'timer-ended' : ''}" id="t_${i}" onclick="toggleFocus(${i})" style="cursor:pointer;" title="Abrir modo foco">${mmss(b.timer.rem)}</div>
             </div>
             <div class="manual-box">
              <div style="margin-bottom:8px;">${escapeHTML(b.manual.explain)}</div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:11px;">
                <div style="color:var(--accent-3)"><b>BIEN:</b> ${escapeHTML(b.manual.good)}</div>
                <div style="color:var(--accent-2)"><b>MAL:</b> ${escapeHTML(b.manual.bad)}</div>
              </div>
              ${b.manual.stop ? `<div style="margin-top:8px; font-size:10px; color:var(--accent-2); border-top:1px solid var(--line); pt-4"><b>STOP RULE:</b> ${escapeHTML(b.manual.stop)}</div>` : ''}
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px;">
              <div class="manual-box" style="margin:0; padding:8px;">
                <label style="font-size:9px; color:var(--muted); text-transform:uppercase; display:block; margin-bottom:4px;">Racha M√°x</label>
                <div style="display:flex; align-items:center; gap:6px;">
                  <button class="btn ghost" onclick="bumpMetric(${i},'racha',-1)" style="padding:2px 10px; min-height:36px; font-size:18px; flex-shrink:0;">‚àí</button>
                  <span id="m_racha_${i}" style="flex:1; text-align:center; font-family:var(--font-display); font-weight:900; font-size:22px;">${b.metrics.racha}</span>
                  <button class="btn accent" onclick="bumpMetric(${i},'racha',1)" style="padding:2px 10px; min-height:36px; font-size:18px; flex-shrink:0;">+</button>
                </div>
              </div>
              <div class="manual-box" style="margin:0; padding:8px;">
                <label style="font-size:9px; color:var(--muted); text-transform:uppercase; display:block; margin-bottom:4px;">Aciertos</label>
                <div style="display:flex; align-items:center; gap:6px;">
                  <button class="btn ghost" onclick="bumpMetric(${i},'aciertos',-1)" style="padding:2px 10px; min-height:36px; font-size:18px; flex-shrink:0;">‚àí</button>
                  <span id="m_aciertos_${i}" style="flex:1; text-align:center; font-family:var(--font-display); font-weight:900; font-size:22px;">${b.metrics.aciertos}</span>
                  <button class="btn accent" onclick="bumpMetric(${i},'aciertos',1)" style="padding:2px 10px; min-height:36px; font-size:18px; flex-shrink:0;">+</button>
                </div>
              </div>
            </div>
            <div class="row" style="margin-top:16px;">
              <button class="btn ${b.timer.active ? 'ghost' : 'accent'}" onclick="toggleT(${i})">${b.timer.active ? 'Pausar' : (b.timer.finished ? 'Reiniciar' : 'Empezar')}</button>
              <button class="btn ghost" style="padding:8px 12px; font-size:10px;" onclick="skipT(${i})">Hecho</button>
            </div>
          </div>
        `).join("");
      }
      renderChart();
      updateBallAdvice();
      const st = document.getElementById("safetyText");
      if (st) {
        st.textContent = state.safety_accepted ? "OK" : "REQUERIDAS";
        st.parentElement.style.borderColor = state.safety_accepted ? "var(--accent-3)" : "var(--accent-2)";
        st.parentElement.style.color = state.safety_accepted ? "var(--accent-3)" : "var(--accent-2)";
      }
    }

    window.updateMetric = (idx, key, val) => {
      if (!state.session) return;
      state.session.blocks[idx].metrics[key] = parseInt(val, 10) || 0;
      save();
    };

    window.toggleT = async (idx) => {
      if (!state.session) return;
      const b = state.session.blocks[idx];
      const active = !b.timer.active;
      state.session.blocks.forEach((x, j) => { if (j !== idx && x.timer.active) { x.timer.active = false; x.timer.endTime = null; } });
      if (active) {
        if (b.timer.finished) { b.timer.rem = b.seconds; b.timer.finished = false; }
        b.timer.active = true; b.timer.endTime = Date.now() + (b.timer.rem * 1000);
        Alarm.play("start"); vibe([100, 50, 100]);
        Speak.say(`${b.title}. ${mmss(b.timer.rem)} minutos`, true);
        toggleWake(true);
      } else {
        if (b.timer.endTime) b.timer.rem = Math.ceil((b.timer.endTime - Date.now()) / 1000);
        b.timer.active = false; b.timer.endTime = null;
        Speak.say("Pausado", true); vibe(200);
        // Keep wake lock active while session exists ‚Äî release only on session end
      }
      save(); render();
    };

    window.skipT = (idx) => {
      if (!state.session) return;
      const b = state.session.blocks[idx];
      b.timer.active = false; b.timer.rem = 0; b.timer.finished = true; b.timer.endTime = null;
      Speak.say("Bloque omitido", true);
      save(); render();
    };

    // ---- Focus Mode ----
    let focusBlockIdx = null;

    window.toggleFocus = (idx, close = false) => {
      const overlay = document.getElementById("focusOverlay");
      if (close || (overlay.classList.contains("active") && idx === null)) {
        overlay.classList.remove("active");
        focusBlockIdx = null;
        return;
      }
      // Resolve active block if no idx given
      if (idx === null || idx === undefined) {
        idx = state.session?.blocks.findIndex(b => b.timer.active);
        if (idx === -1) idx = null;
      }
      focusBlockIdx = idx;
      overlay.classList.add("active");
      if (idx !== null && state.session?.blocks[idx]) {
        const b = state.session.blocks[idx];
        const ep = document.getElementById("focusPill"); if (ep) ep.textContent = b.label;
        const et = document.getElementById("focusTitle"); if (et) et.textContent = b.title;
        updateFocusOverlay(idx);
        Speak.say(`${b.title}. ${b.manual.explain}`, false);
      }
    };

    function updateFocusOverlay(idx) {
      if (idx === null || idx === undefined || !state.session?.blocks[idx]) return;
      const b = state.session.blocks[idx];
      const te = document.getElementById("focusTime"); if (te) te.textContent = mmss(b.timer.rem);
      const re = document.getElementById("focusRacha"); if (re) re.textContent = b.metrics.racha;
      const ae = document.getElementById("focusAciertos"); if (ae) ae.textContent = b.metrics.aciertos;
      const circle = document.getElementById("focusCircle");
      if (circle && b.seconds > 0) circle.style.strokeDashoffset = 283 * (1 - b.timer.rem / b.seconds);
    }

    window.focusBump = (key) => {
      if (focusBlockIdx === null || !state.session) return;
      const b = state.session.blocks[focusBlockIdx];
      b.metrics[key] = Math.max(0, (b.metrics[key] || 0) + 1);
      save();
      updateFocusOverlay(focusBlockIdx);
      vibe(50); Alarm.play("tick");
      Speak.say(`${key === "racha" ? "Racha" : "Aciertos"}: ${b.metrics[key]}`);
    };

    window.announceBlock = () => {
      if (focusBlockIdx === null || !state.session) return;
      const b = state.session.blocks[focusBlockIdx];
      Speak.say(`${b.title}. ${b.manual.explain}. Bien: ${b.manual.good}. Evitar: ${b.manual.bad}.`, true);
    };

    window.bumpMetric = (idx, key, delta) => {
      if (!state.session) return;
      const b = state.session.blocks[idx];
      b.metrics[key] = Math.max(0, (b.metrics[key] || 0) + delta);
      save();
      const el = document.getElementById(`m_${key}_${idx}`);
      if (el) el.textContent = b.metrics[key];
      if (focusBlockIdx === idx) updateFocusOverlay(idx);
      vibe(50);
    };

    // ---- Main Timer Loop ----
    setInterval(() => {
      if (!state.session?.blocks) return;
      state.session.blocks.forEach((b, i) => {
        if (b.timer.active && b.timer.endTime) {
          const rem = Math.ceil((b.timer.endTime - Date.now()) / 1000);
          const prevRem = b.timer.rem;
          b.timer.rem = Math.max(0, rem);

          // Countdown audio cues ‚Äî only trigger once per second change
          if (b.timer.rem !== prevRem && !b.timer.isRest) {
            if (b.timer.rem === 30) { Alarm.play("warning"); vibe([50, 100, 50]); Speak.say("30 segundos"); }
            else if (b.timer.rem === 10) { Alarm.play("warning"); vibe([50, 100, 50]); Speak.say("10 segundos"); }
            else if (b.timer.rem === 5) { Speak.say("5, 4, 3, 2, 1"); }
          }

          // Random tactical cue via voice (not just toast)
          if (b.timer.rem % 30 === 0 && b.timer.rem > 0 && b.timer.rem !== prevRem && !b.timer.isRest) {
            if (Math.random() > 0.7) Speak.say("Visualiza a tu oponente en la T");
          }

          if (b.timer.rem === 0) {
            // Density interval transition
            if (b.density && !b.timer.finished) {
              const [, rest] = b.density.split("/").map(Number);
              if (!b.timer.isRest) {
                b.timer.isRest = true; b.timer.rem = rest;
                b.timer.endTime = Date.now() + (rest * 1000);
                Alarm.play("rest"); vibe([200, 100, 200]);
                Speak.say("Pausa activa", true); toast("PAUSA ACTIVA");
                return;
              }
            }

            b.timer.active = false; b.timer.finished = true; b.timer.endTime = null; b.timer.isRest = false;
            Alarm.play("end"); vibe([300, 100, 300]);
            Speak.say(`Bloque completado. ${b.title} finalizado.`, true);

            // Web notification (works even with screen dimmed on some devices)
            if (state.notif && Notification.permission === "granted") {
              try { new Notification("Squash Solo", { body: `${b.title} completado`, silent: false }); } catch(e) {}
            }

            if (state.auto_advance) {
              const next = state.session.blocks.findIndex((x, j) => j > i && !x.timer.finished);
              if (next !== -1) {
                const nb = state.session.blocks[next];
                Speak.say(`Siguiente: ${nb.title}`);
                setTimeout(() => {
                  window.toggleT(next);
                  // Update focus overlay to new block if it was open
                  if (focusBlockIdx !== null) {
                    focusBlockIdx = next;
                    const ep = document.getElementById("focusPill"); if (ep) ep.textContent = nb.label;
                    const et = document.getElementById("focusTitle"); if (et) et.textContent = nb.title;
                  }
                }, 1500);
              } else {
                Speak.say("Entrenamiento completado. Excelente trabajo.");
                if (focusBlockIdx !== null) toggleFocus(null, true);
              }
            }
            save(); render();
          } else {
            const el = document.getElementById(`t_${i}`); if (el) {
              el.textContent = mmss(b.timer.rem);
              if (b.timer.isRest) el.style.color = "var(--accent-3)";
              else el.style.color = b.timer.active ? "var(--accent)" : "var(--ink)";
            }
            // Keep focus overlay in sync
            if (focusBlockIdx === i) updateFocusOverlay(i);
          }
        }
      });
    }, 500);

    document.getElementById("btnComplete").onclick = () => {
      const rpe = parseInt(document.getElementById("rpeInput").value, 10);
      if (!rpe || rpe < 1 || rpe > 10) { alert("Esfuerzo 1-10"); return; }
      state.history.push({ date: nowISODate(), n: state.session.n, plan: state.session.plan_name, rpe, notes: document.getElementById("notesInput").value });
      state.count = state.session.n; state.session = null; save(); render(); toast("Guardado");
      toggleWake(false);
    };

    document.getElementById("btnReset").onclick = () => { if (confirm("¬øDescartar?")) { state.session = null; save(); render(); toggleWake(false); } };

    // Re-sync timers when returning from background / screen-off
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        ensureSessionIntegrity();
        render();
        if (state.session) {
          // Re-request wake lock if it was released by the OS
          toggleWake(true);
          const activeBlock = state.session.blocks.find(b => b.timer.active);
          if (activeBlock) {
            Alarm.play("warning");
            Speak.say(`Reanudando. ${activeBlock.title}. ${mmss(activeBlock.timer.rem)} restantes.`, true);
          }
        }
      }
    });
    document.getElementById("themeToggle").onclick = () => { state.theme = state.theme === "light" ? "dark" : "light"; save(); render(); };
    document.getElementById("durationSelect").onchange = e => { state.total_min = parseInt(e.target.value, 10); save(); if (!state.session) render(); };
    document.getElementById("planSelect").onchange = e => { state.plan_id = e.target.value; save(); if (!state.session) render(); };

    document.getElementById("btnAuto").onclick = () => {
      state.auto_advance = !state.auto_advance;
      document.getElementById("btnAuto").textContent = `AUTO: ${state.auto_advance ? 'ON' : 'OFF'}`;
      save();
    };

    document.getElementById("btnNotif").onclick = async () => {
      const res = await Notification.requestPermission();
      if (res === "granted") { state.notif = !state.notif; document.getElementById("btnNotif").textContent = `AVISOS: ${state.notif ? 'ON' : 'OFF'}`; save(); }
    };

    document.getElementById("btnExportCSV").onclick = () => {
      const esc = v => `"${String(v ?? "").replace(/"/g, '""')}"`;
      const head = ["date", "n", "plan", "rpe", "notes"].map(esc).join(",");
      const body = state.history.map(h => [h.date, h.n, h.plan, h.rpe, h.notes].map(esc).join(",")).join("\n");
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([head + "\n" + body], { type: "text/csv" }));
      a.download = `squash_${nowISODate()}.csv`; a.click();
    };

    document.getElementById("btnWipe").onclick = () => { if (confirm("¬øBorrar todo?")) { state = structuredClone(DEFAULT_STATE); save(); render(); initUI(); } };

    function initUI() {
      const sp = document.getElementById("planSelect");
      sp.innerHTML = catalog.plans.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
      sp.value = state.plan_id;
      document.getElementById("durationSelect").value = state.total_min;
      document.getElementById("btnAuto").textContent = `AUTO: ${state.auto_advance ? 'ON' : 'OFF'}`;
      document.getElementById("btnNotif").textContent = `AVISOS: ${state.notif ? 'ON' : 'OFF'}`;
    }

    document.getElementById("txtImport").onchange = async e => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      const parsed = parseExercisesTXT(text);
      if (!parsed.length) { toast("TXT vac√≠o o formato inv√°lido"); return; }
      state.custom_exercises = [...state.custom_exercises, ...parsed];
      save();
      mergeCustomExercises();
      render();
      renderCustomList();
      toast(`${parsed.length} ejercicios importados`);
      e.target.value = "";
    };

    document.getElementById("btnAddEx").onclick = () => {
      const title = document.getElementById("exTitle").value.trim();
      const setup = document.getElementById("exSetup").value.trim();
      const explain = document.getElementById("exExplain").value.trim();
      const good = document.getElementById("exGood").value.trim();
      const bad = document.getElementById("exBad").value.trim();
      const blockId = document.getElementById("exBlock").value;

      if (!title) { toast("T√≠tulo requerido"); return; }

      const newEx = {
        id: `custom_${Date.now()}`,
        stage: 1,
        title,
        setup: setup || "Sin setup definido.",
        manual: {
          explain: explain || "Practica con control y ritmo progresivo.",
          good: good || "Impacto limpio y balanceado.",
          bad: bad || "Forzar velocidad sin t√©cnica."
        },
        blockId
      };

      state.custom_exercises.push(newEx);
      save();
      mergeCustomExercises();
      render();
      renderCustomList();
      toast("Ejercicio a√±adido");

      // Reset fields
      document.getElementById("exTitle").value = "";
      document.getElementById("exSetup").value = "";
      document.getElementById("exExplain").value = "";
      document.getElementById("exGood").value = "";
      document.getElementById("exBad").value = "";
    };

    mergeCustomExercises();
    initUI(); render(); renderCustomList();
    Speak.init();
    // Restore wake lock if session was active before page reload
    if (state.session) toggleWake(true);
  </script>
</body>

</html>